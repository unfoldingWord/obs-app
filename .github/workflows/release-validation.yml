name: Release Validation

on:
  pull_request:
    branches: [main]                # PRs to main (usually release branches)
    paths:
      - 'app.json'
      - 'package.json'
      - 'CHANGELOG.md'
      - 'eas.json'
  push:
    tags:
      - 'v*'                        # Validate tags before release workflow

jobs:
  validate-release:
    name: Validate Release Preparation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate app.json
        run: |
          echo "ğŸ” Validating app.json..."

          # Check app.json is valid JSON
          if ! jq empty app.json 2>/dev/null; then
            echo "âŒ app.json is not valid JSON"
            exit 1
          fi

          # Extract version info
          VERSION=$(jq -r '.expo.version' app.json)
          ANDROID_VERSION_CODE=$(jq -r '.expo.android.versionCode // empty' app.json)
          IOS_BUILD_NUMBER=$(jq -r '.expo.ios.buildNumber // empty' app.json)

          echo "ğŸ“± App version: $VERSION"
          echo "ğŸ¤– Android versionCode: ${ANDROID_VERSION_CODE:-"Not set"}"
          echo "ğŸ iOS buildNumber: ${IOS_BUILD_NUMBER:-"Not set"}"

          # Validate version format (semantic versioning)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi

          echo "âœ… app.json validation passed"

      - name: Validate package.json
        run: |
          echo "ğŸ” Validating package.json..."

          # Check package.json is valid JSON
          if ! jq empty package.json 2>/dev/null; then
            echo "âŒ package.json is not valid JSON"
            exit 1
          fi

          PKG_VERSION=$(jq -r '.version' package.json)
          echo "ğŸ“¦ Package version: $PKG_VERSION"

          # Validate version format
          if [[ ! $PKG_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âŒ Invalid package version format: $PKG_VERSION"
            exit 1
          fi

          echo "âœ… package.json validation passed"

      - name: Check version consistency (for release branches)
        if: startsWith(github.head_ref, 'release/') || startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "ğŸ” Checking version consistency..."

          APP_VERSION=$(jq -r '.expo.version' app.json)
          PKG_VERSION=$(jq -r '.version' package.json)

          echo "ğŸ“± app.json version: $APP_VERSION"
          echo "ğŸ“¦ package.json version: $PKG_VERSION"

          # For tags, extract version from tag name
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_VERSION="${{ github.ref }}"
            TAG_VERSION=${TAG_VERSION#refs/tags/v}
            echo "ğŸ·ï¸  Tag version: $TAG_VERSION"

            # All three should match for tag releases
            if [[ "$APP_VERSION" != "$TAG_VERSION" || "$PKG_VERSION" != "$TAG_VERSION" ]]; then
              echo "âŒ Version mismatch detected!"
              echo "   Tag version: $TAG_VERSION"
              echo "   app.json: $APP_VERSION"
              echo "   package.json: $PKG_VERSION"
              echo ""
              echo "ğŸ’¡ For tag releases, all versions must match exactly."
              exit 1
            fi
          else
            # For release branches, app.json and package.json should match
            if [[ "$APP_VERSION" != "$PKG_VERSION" ]]; then
              echo "âŒ Version mismatch between app.json and package.json"
              echo "   app.json version: $APP_VERSION"
              echo "   package.json version: $PKG_VERSION"
              echo ""
              echo "ğŸ’¡ These should match for consistent releases."
              exit 1
            fi
          fi

          echo "âœ… Version consistency check passed"

      - name: Validate eas.json
        run: |
          echo "ğŸ” Validating eas.json..."

          # Check eas.json is valid JSON
          if ! jq empty eas.json 2>/dev/null; then
            echo "âŒ eas.json is not valid JSON"
            exit 1
          fi

          # Check required profiles exist
          PROFILES=$(jq -r '.build | keys[]' eas.json)
          echo "ğŸ“‹ Build profiles: $PROFILES"

          # Check production profile exists
          if ! echo "$PROFILES" | grep -q "production"; then
            echo "âŒ Missing required 'production' build profile"
            exit 1
          fi

          # Validate production profile structure
          PROD_ANDROID=$(jq -r '.build.production.android // empty' eas.json)
          PROD_IOS=$(jq -r '.build.production.ios // empty' eas.json)

          if [[ -z "$PROD_ANDROID" ]]; then
            echo "âŒ Missing production.android configuration"
            exit 1
          fi

          if [[ -z "$PROD_IOS" ]]; then
            echo "âŒ Missing production.ios configuration"
            exit 1
          fi

          echo "âœ… eas.json validation passed"

      - name: Check CHANGELOG.md (for release branches)
        if: startsWith(github.head_ref, 'release/')
        run: |
          echo "ğŸ” Checking CHANGELOG.md..."

          if [[ ! -f CHANGELOG.md ]]; then
            echo "âš ï¸  CHANGELOG.md not found (recommended for releases)"
            exit 0
          fi

          # Extract version from branch name (release/v1.2.0 -> 1.2.0)
          BRANCH_VERSION="${{ github.head_ref }}"
          BRANCH_VERSION=${BRANCH_VERSION#release/v}
          BRANCH_VERSION=${BRANCH_VERSION#release/}

          echo "ğŸ·ï¸  Release version: $BRANCH_VERSION"

          # Check if version is mentioned in CHANGELOG
          if grep -q "$BRANCH_VERSION" CHANGELOG.md; then
            echo "âœ… Version $BRANCH_VERSION found in CHANGELOG.md"
          else
            echo "âš ï¸  Version $BRANCH_VERSION not found in CHANGELOG.md"
            echo "ğŸ’¡ Consider adding release notes for this version"
          fi

      - name: Lint check
        run: |
          echo "ğŸ” Running lint checks..."

          # Run ESLint if configured
          if [[ -f .eslintrc.js ]] || [[ -f .eslintrc.json ]] || grep -q eslint package.json 2>/dev/null; then
            echo "ğŸ”§ Running ESLint..."
            npm run lint --if-present || echo "âš ï¸  Lint script not found, skipping"
          else
            echo "âš ï¸  ESLint not configured, skipping"
          fi

      - name: Type check
        run: |
          echo "ğŸ” Running type checks..."

          # Run TypeScript check if configured
          if [[ -f tsconfig.json ]]; then
            echo "ğŸ“ Running TypeScript check..."
            npx tsc --noEmit --skipLibCheck || echo "âš ï¸  TypeScript check failed"
          else
            echo "ğŸ’¡ No tsconfig.json found, skipping TypeScript check"
          fi

      - name: Release validation summary
        run: |
          echo "ğŸ‰ Release validation completed!"
          echo ""
          echo "ğŸ“‹ Validation Results:"
          echo "  âœ… app.json format and versioning"
          echo "  âœ… package.json format and versioning"
          echo "  âœ… eas.json configuration"
          if [[ "${{ startsWith(github.head_ref, 'release/') }}" == "true" ]]; then
            echo "  âœ… Version consistency across files"
            echo "  âœ… CHANGELOG.md check"
          fi
          echo "  âœ… Code quality checks"
          echo ""
          echo "ğŸš€ Ready for release process!"

      - name: Next steps (for release branches)
        if: startsWith(github.head_ref, 'release/')
        run: |
          echo "ğŸ“‹ Next Steps for Release:"
          echo ""
          echo "1. ğŸ” Review this PR thoroughly"
          echo "2. âœ… Get approvals from team members"
          echo "3. ğŸ”„ Merge this PR to main"
          echo "4. ğŸ·ï¸  Create GitHub release with tag"
          echo "5. ğŸš€ Automatic build & store submission will start"
          echo ""
          echo "ğŸ“± Monitor progress at:"
          echo "   EAS: https://expo.dev/accounts/unfoldingword/projects/obs-app"
          echo "   Actions: ${{ github.server_url }}/${{ github.repository }}/actions"
