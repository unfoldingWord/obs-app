name: Test EAS Setup

on:
  push:
    branches: [feature/eas-configuration, feature/github-setup-checklist]
  workflow_dispatch:

jobs:
  test-setup:
    name: Test EAS Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate eas.json
        run: |
          echo "ðŸ” Validating eas.json configuration..."
          if [ -f "eas.json" ]; then
            echo "âœ… eas.json exists"
            # Check if it's valid JSON
            if node -e "JSON.parse(require('fs').readFileSync('eas.json', 'utf8'))"; then
              echo "âœ… eas.json is valid JSON"
            else
              echo "âŒ eas.json is invalid JSON"
              exit 1
            fi
          else
            echo "âŒ eas.json not found"
            exit 1
          fi

      - name: Check app.json
        run: |
          echo "ðŸ” Checking app.json..."
          if [ -f "app.json" ]; then
            echo "âœ… app.json exists"
            # Extract app name
            APP_NAME=$(node -e "console.log(JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.name)")
            echo "ðŸ“± App name: $APP_NAME"
          else
            echo "âŒ app.json not found"
            exit 1
          fi

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Test EAS CLI
        run: |
          echo "ðŸ” Testing EAS CLI installation..."
          eas --version
          echo "âœ… EAS CLI is working"

      - name: Validate EAS config (without auth)
        run: |
          echo "ðŸ” Validating EAS configuration..."
          echo "Build profiles configured:"
          node -e "
            const config = JSON.parse(require('fs').readFileSync('eas.json', 'utf8'));
            Object.keys(config.build).forEach(profile => {
              console.log('  -', profile);
            });
          "
          echo "âœ… EAS configuration looks good!"

      - name: Summary
        run: |
          echo "ðŸŽ‰ Setup Validation Complete!"
          echo ""
          echo "âœ… All configuration files are valid"
          echo "âœ… EAS CLI can be installed"
          echo "âœ… Build profiles are configured"
          echo ""
          echo "ðŸ”‘ Next step: unfoldingword account manager needs to:"
          echo "   1. Add EXPO_TOKEN to GitHub secrets"
          echo "   2. Initialize EAS project (âœ… DONE)"
          echo "   3. Test first build manually"
          echo ""
          echo "ðŸ’¡ To trigger builds manually:"
          echo "   - Go to Actions â†’ 'EAS Build (Conservative)'"
          echo "   - Click 'Run workflow'"
          echo "   - Choose platform and profile"
